.PHONY: help init build deploy apply geturlsgrafana simulate cleanup status logs

help: ## Affiche l'aide
	@echo "Stack DevOps UnifiÃ© avec Dashboard Grafana AvancÃ©"
	@echo "================================================="
	@echo "Commandes disponibles:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

init: ## Initialise l'environnement (Minikube + Terraform)
	@echo "ğŸš€ Initialisation de l'environnement..."
	@chmod +x scripts/*.sh
	@./scripts/setup.sh
	@cd monitoring/terraform && terraform init
	@echo "âœ… Initialisation terminÃ©e!"

build: ## Build l'image Docker FastAPI
	@echo "ğŸ”¨ Construction de l'image Docker..."
	@eval $$(minikube docker-env) && docker build -t fastapi-devops:latest apps/fastapi/
	@echo "âœ… Image construite!"

deploy: ## DÃ©ploie les ressources Kubernetes
	@echo "ğŸ“¦ DÃ©ploiement des ressources..."
	@cd monitoring/terraform && terraform apply -auto-approve
	@kubectl apply -f k8s/monitoring/ -R
	@kubectl apply -f k8s/fastapi/
	@echo "â³ Attente que les services soient prÃªts..."
	@kubectl wait --for=condition=ready pod -l app=prometheus --timeout=120s
	@kubectl wait --for=condition=ready pod -l app=grafana --timeout=120s
	@kubectl wait --for=condition=ready pod -l app=fastapi-app --timeout=120s
	@echo "âœ… DÃ©ploiement terminÃ©!"

apply: init build deploy ## Lance la stack complÃ¨te
	@echo "ğŸ‰ Stack DevOps UnifiÃ© dÃ©ployÃ©e avec succÃ¨s!"
	@echo "ğŸ“Š Dashboard Grafana avancÃ© avec 9 panneaux configurÃ©!"
	@echo "ğŸ“‹ Lancez 'make geturlsgrafana' pour obtenir les URLs"

geturlsgrafana: ## Affiche les URLs Grafana et autres services
	@./scripts/urls.sh

simulate: ## Simule du trafic pour gÃ©nÃ©rer des mÃ©triques
	@echo "ğŸ”„ Simulation de trafic..."
	@FASTAPI_URL=$$(minikube service fastapi-service --url 2>/dev/null | head -1); \
	if [ ! -z "$$FASTAPI_URL" ]; then \
		echo "ğŸ“ˆ GÃ©nÃ©ration de trafic vers $$FASTAPI_URL"; \
		for i in {1..100}; do \
			curl -s "$$FASTAPI_URL/" > /dev/null & \
			curl -s "$$FASTAPI_URL/simulate-load" > /dev/null & \
			curl -s "$$FASTAPI_URL/api/users" > /dev/null & \
			curl -s "$$FASTAPI_URL/health" > /dev/null & \
		done; \
		wait; \
		echo "âœ… Trafic simulÃ©! Consultez Grafana pour voir les 9 dashboards avancÃ©s."; \
		echo "ğŸ“Š Dashboard: 'FastAPI DevOps Stack - Complete Monitoring'"; \
	else \
		echo "âŒ Service FastAPI non accessible"; \
	fi

simulate-load: ## Simulation intensive pour plus de mÃ©triques
	@echo "ğŸš€ Simulation de charge intensive..."
	@FASTAPI_URL=$$(minikube service fastapi-service --url 2>/dev/null | head -1); \
	if [ ! -z "$$FASTAPI_URL" ]; then \
		for round in {1..5}; do \
			echo "ğŸ”„ Round $$round/5"; \
			for i in {1..50}; do \
				curl -s "$$FASTAPI_URL/" > /dev/null & \
				curl -s "$$FASTAPI_URL/simulate-load" > /dev/null & \
				curl -s "$$FASTAPI_URL/api/users" > /dev/null & \
			done; \
			wait; \
			sleep 2; \
		done; \
		echo "âœ… Charge intensive terminÃ©e!"; \
	fi

status: ## Affiche le statut des services
	@echo "ğŸ“Š Statut des services:"
	@kubectl get pods -o wide
	@echo "\nğŸ”— Services:"
	@kubectl get services
	@echo "\nğŸ“ˆ ConfigMaps Grafana:"
	@kubectl get configmaps | grep grafana

logs: ## Affiche les logs de l'application FastAPI
	@kubectl logs -l app=fastapi-app --tail=50

logs-grafana: ## Logs Grafana
	@kubectl logs -l app=grafana --tail=50

logs-prometheus: ## Logs Prometheus
	@kubectl logs -l app=prometheus --tail=50

restart-grafana: ## RedÃ©marre Grafana (utile si dashboard ne s'affiche pas)
	@kubectl rollout restart deployment/grafana
	@kubectl rollout status deployment/grafana
	@echo "âœ… Grafana redÃ©marrÃ©! Dashboard avancÃ© rechargÃ©."

test-metrics: ## Teste les mÃ©triques Prometheus
	@echo "ğŸ” Test des mÃ©triques..."
	@FASTAPI_URL=$$(minikube service fastapi-service --url 2>/dev/null | head -1); \
	if [ ! -z "$$FASTAPI_URL" ]; then \
		echo "ğŸ“Š MÃ©triques disponibles:"; \
		curl -s "$$FASTAPI_URL/metrics" | grep -E "(http_requests_total|http_request_duration|business_operations)" | head -10; \
	fi

cleanup: ## Nettoie l'environnement complet
	@./scripts/cleanup.sh

dashboard-info: ## Infos sur le dashboard Grafana
	@echo "ğŸ“Š Dashboard Grafana UnifiÃ© - Informations"
	@echo "=========================================="
	@echo "Nom: FastAPI DevOps Stack - Complete Monitoring"
	@echo "Panneaux: 9 visualisations avancÃ©es"
	@echo "1. ğŸš€ API Request Rate - Taux requÃªtes/sec"
	@echo "2. âš¡ Response Time Percentiles - Latence dÃ©taillÃ©e"
	@echo "3. ğŸ¯ HTTP Status Codes - RÃ©partition des codes"
	@echo "4. ğŸ“ˆ Request Rate by Endpoint - Par endpoint"
	@echo "5. ğŸ”§ Business Operations - MÃ©triques mÃ©tier"
	@echo "6. âš ï¸  Error Rate - Pourcentage d'erreurs"
	@echo "7. ğŸš¦ Service Health - Statut du service"
	@echo "8. ğŸ“Š Request Volume - Volume dans le temps"
	@echo "9. â±ï¸  Response Time Heatmap - Heatmap avancÃ©e"
	@echo "Refresh: Automatique toutes les 5 secondes"
	@echo "Seuils: ColorÃ©s (vert/jaune/rouge)"

dev-restart-app: ## RedÃ©marre l'application FastAPI
	@kubectl rollout restart deployment/fastapi-app
	@kubectl rollout status deployment/fastapi-app

dev-shell: ## Shell interactif dans un pod FastAPI
	@kubectl exec -it $$(kubectl get pods -l app=fastapi-app -o jsonpath='{.items[0].metadata.name}') -- /bin/bash

quick-deploy: ## DÃ©ploiement rapide (sans Terraform)
	@echo "ğŸƒâ€â™‚ï¸ DÃ©ploiement rapide..."
	@kubectl apply -f k8s/monitoring/ -R
	@kubectl apply -f k8s/fastapi/
	@echo "âœ… DÃ©ploiement rapide terminÃ©!"

port-forward-grafana: ## Port-forward Grafana sur localhost:3000
	@echo "ğŸ”— Port-forward Grafana vers localhost:3000"
	@kubectl port-forward service/grafana 3000:3000

port-forward-prometheus: ## Port-forward Prometheus sur localhost:9090
	@echo "ğŸ”— Port-forward Prometheus vers localhost:9090"
	@kubectl port-forward service/prometheus 9090:9090
